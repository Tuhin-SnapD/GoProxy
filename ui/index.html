<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GoProxy Dashboard</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 24px; }
      .container { max-width: 1100px; margin: 0 auto; }
      header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; gap: 12px; flex-wrap: wrap; }
      h1 { font-size: 22px; margin: 0; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
      .card { border: 1px solid #ccc3; border-radius: 10px; padding: 16px; background: #fff0; backdrop-filter: blur(2px); }
      .metric { font-size: 28px; font-weight: 700; margin-top: 8px; }
      .sub { color: #666; font-size: 12px; }
      .row { display: flex; align-items: center; gap: 8px; justify-content: space-between; }
      .spark { height: 48px; width: 100%; }
      button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc6; background: #f6f6f6; cursor: pointer; }
      a { color: inherit; }
      table { width: 100%; border-collapse: collapse; font-size: 13px; }
      th, td { padding: 8px 10px; border-top: 1px solid #ccc3; text-align: left; white-space: nowrap; }
      th { position: sticky; top: 0; backdrop-filter: blur(2px); background: #fff8; }
      .table-wrap { max-height: 360px; overflow: auto; border: 1px solid #ccc3; border-radius: 10px; }
      .pill { border: 1px solid #ccc6; border-radius: 999px; padding: 2px 8px; font-size: 12px; }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>GoProxy Dashboard</h1>
        <div class="row">
          <a href="/metrics" target="_blank">Open /metrics</a>
          <a href="/metrics.json" target="_blank">Open /metrics.json</a>
          <a href="/requests.json" target="_blank">Open /requests.json</a>
          <button id="refresh">Refresh</button>
        </div>
      </header>

      <div class="grid">
        <div class="card">
          <div class="sub">Total Requests</div>
          <div id="total_requests" class="metric">—</div>
        </div>
        <div class="card">
          <div class="sub">Cache Hit Rate</div>
          <div id="cache_hit_rate" class="metric">—%</div>
        </div>
        <div class="card">
          <div class="sub">Cache</div>
          <div class="row">
            <div>
              <div class="sub">Hits</div>
              <div id="cache_hits" class="metric">—</div>
            </div>
            <div>
              <div class="sub">Misses</div>
              <div id="cache_misses" class="metric">—</div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="sub">Blocked (Rate Limit)</div>
          <div id="blocked_requests" class="metric">—</div>
        </div>
        <div class="card">
          <div class="sub">Avg Response Time</div>
          <div id="average_response_time_ms" class="metric">— ms</div>
        </div>
        <div class="card">
          <div class="sub">Uptime</div>
          <div id="uptime_seconds" class="metric">— s</div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="sub">Response Time Trend (ms)</div>
        <svg id="spark" class="spark" viewBox="0 0 100 48" preserveAspectRatio="none"></svg>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="row"><div class="sub">Recent Requests</div><span class="pill" id="req_count">—</span></div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Method</th>
                <th>Path</th>
                <th>Status</th>
                <th>Host</th>
                <th>Scheme</th>
                <th>Client IP</th>
                <th>Duration</th>
                <th>Size</th>
                <th>Type</th>
                <th>User Agent</th>
                <th>Referrer</th>
                <th>Cache</th>
                <th>TTL</th>
              </tr>
            </thead>
            <tbody id="req_tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const ids = [
        'total_requests','cache_hits','cache_misses','blocked_requests','cache_hit_rate','average_response_time_ms','uptime_seconds'
      ];
      const state = { history: [] };

      async function fetchMetrics() {
        try {
          const res = await fetch('/metrics.json',{cache:'no-store'});
          if (!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          ids.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            const val = data[id];
            if (id === 'cache_hit_rate') el.textContent = (val ?? 0).toFixed(2)+'%';
            else if (id === 'average_response_time_ms') el.textContent = (val ?? 0).toFixed(2)+' ms';
            else el.textContent = val ?? '—';
          });
          // Track response time trend
          state.history.push(data.average_response_time_ms || 0);
          if (state.history.length > 50) state.history.shift();
          drawSpark();
        } catch (e) {
          console.error('Metrics fetch failed', e);
        }
      }

      function drawSpark() {
        const svg = document.getElementById('spark');
        const w = 100, h = 48; // viewBox
        const arr = state.history;
        if (arr.length < 2) { svg.innerHTML = ''; return; }
        const max = Math.max(...arr, 1);
        const min = Math.min(...arr, 0);
        const span = Math.max(max - min, 1);
        const pts = arr.map((v, i) => {
          const x = (i / (arr.length - 1)) * w;
          const y = h - ((v - min) / span) * (h - 2) - 1;
          return `${x.toFixed(2)},${y.toFixed(2)}`;
        }).join(' ');
        svg.innerHTML = `<polyline fill="none" stroke="currentColor" stroke-width="2" points="${pts}" />`;
      }

      async function fetchRequests() {
        try {
          const res = await fetch('/requests.json',{cache:'no-store'});
          if (!res.ok) throw new Error('HTTP '+res.status);
          const arr = await res.json();
          document.getElementById('req_count').textContent = arr.length;
          const tbody = document.getElementById('req_tbody');
          tbody.innerHTML = arr.slice().reverse().map(r => {
            const when = new Date(r.timestamp).toLocaleTimeString();
            const dur = (r.duration_ms ?? 0).toFixed(1)+' ms';
            const size = (r.bytes ?? 0)+' B';
            const cache = r.cache_hit ? 'HIT' : '';
            const ttl = r.cache_ttl_remaining_ms ? (r.cache_ttl_remaining_ms/1000).toFixed(1)+' s' : '';
            const statusColor = r.status >= 500 ? '#e74c3c' : r.status >= 400 ? '#f39c12' : '#2ecc71';
            return `<tr>
              <td>${when}</td>
              <td>${r.method}</td>
              <td title="${r.path}">${r.path}</td>
              <td style="color:${statusColor}">${r.status}</td>
              <td title="${r.host || ''}">${r.host || ''}</td>
              <td>${r.scheme || ''}</td>
              <td>${r.client_ip || ''}</td>
              <td>${dur}</td>
              <td>${size}</td>
              <td>${r.content_type || ''}</td>
              <td title="${r.user_agent || ''}">${(r.user_agent || '').slice(0,40)}${(r.user_agent||'').length>40?'…':''}</td>
              <td title="${r.referer || ''}">${r.referer || ''}</td>
              <td>${cache}</td>
              <td>${ttl}</td>
            </tr>`;
          }).join('');
        } catch (e) {
          console.error('Requests fetch failed', e);
        }
      }

      document.getElementById('refresh').addEventListener('click', ()=>{ fetchMetrics(); fetchRequests(); });
      fetchMetrics();
      fetchRequests();
      setInterval(fetchMetrics, 2000);
      setInterval(fetchRequests, 2000);
    </script>
  </body>
  </html>


